# ç”Ÿå‘½å‘¨æœŸ

æ¨¡å—åˆå§‹åŒ–ã€ä¾èµ–æ³¨å…¥ã€æ‹¦æˆªå™¨ã€è¿‡æ»¤å™¨ã€å®ˆå«ç­‰å®Œæ•´æ‰§è¡Œè¿‡ç¨‹ã€‚

------

## ğŸ§© ä¸€ã€å¯åŠ¨é˜¶æ®µï¼ˆåº”ç”¨åˆå§‹åŒ–é˜¶æ®µï¼‰

```latex
bootstrap()                  â† main.ts å…¥å£æ–‡ä»¶
   â”‚
   â”œâ”€> åˆ›å»º NestApplication å®ä¾‹
   â”‚
   â”œâ”€> è§£æ AppModule ä¸­çš„ imports / providers / controllers
   â”‚      â”‚
   â”‚      â”œâ”€> imports: åŠ è½½å…¶ä»–æ¨¡å—ï¼ˆé€’å½’è§£æï¼‰
   â”‚      â”œâ”€> providers: æ³¨å†Œä¾èµ–ï¼ˆæ³¨å…¥å®¹å™¨ï¼‰
   â”‚      â””â”€> controllers: åˆ›å»ºè·¯ç”±æ§åˆ¶å™¨
   â”‚
   â”œâ”€> æ‰§è¡Œå„æ¨¡å—çš„ onModuleInit()
   â”‚
   â”œâ”€> æ‰§è¡Œå„æ¨¡å—çš„ onApplicationBootstrap()
   â”‚
   â””â”€> åº”ç”¨å¼€å§‹ç›‘å¬ç«¯å£ (app.listen)
```

------

## ğŸš¦ äºŒã€è¯·æ±‚é˜¶æ®µï¼ˆå•æ¬¡è¯·æ±‚çš„æ‰§è¡Œæµç¨‹ï¼‰

å½“æœ‰ä¸€ä¸ªè¯·æ±‚è¿›å…¥æ—¶ï¼ŒNestJS ä¼šæŒ‰ç…§ä»¥ä¸‹é¡ºåºæ‰§è¡Œï¼š

```latex
è¯·æ±‚è¿›æ¥
â”‚
â”œâ”€â”€ å…¨å±€ä¸­é—´ä»¶ï¼ˆMiddlewareï¼‰
â”‚
â”œâ”€â”€ å®ˆå«ï¼ˆGuardsï¼‰        â† æ ¡éªŒæ˜¯å¦å…è®¸è¿›å…¥ï¼Œæ¯”å¦‚ JWT éªŒè¯
â”‚
â”œâ”€â”€ æ‹¦æˆªå™¨ before (Interceptors - before)
â”‚       â†“
â”‚       æ§åˆ¶å™¨ (Controller)
â”‚           â†“
â”‚           æœåŠ¡å±‚ (Service)
â”‚       â†‘
â”‚   æ‹¦æˆªå™¨ after (Interceptors - after)
â”‚
â”œâ”€â”€ å¼‚å¸¸è¿‡æ»¤å™¨ (Filters) â† æ•è·æ‰§è¡Œé“¾ä¸­æŠ›å‡ºçš„å¼‚å¸¸
â”‚
â””â”€â”€ å“åº”ç»™å®¢æˆ·ç«¯
```

------

## âš™ï¸ ä¸‰ã€æ¨¡å—ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆModule Lifecycle Hooksï¼‰

| ç”Ÿå‘½å‘¨æœŸé’©å­                  | æ‰€åœ¨æ¥å£                    | è§¦å‘æ—¶æœº             | å¸¸ç”¨åœºæ™¯               |
| ----------------------------- | --------------------------- | -------------------- | ---------------------- |
| `onModuleInit()`              | `OnModuleInit`              | æ¨¡å—ä¾èµ–è§£æå®Œæˆå   | åˆå§‹åŒ–è¿æ¥æ± ã€åŠ è½½ç¼“å­˜ |
| `onApplicationBootstrap()`    | `OnApplicationBootstrap`    | æ•´ä¸ªåº”ç”¨åˆå§‹åŒ–å®Œæˆå | å¯åŠ¨åçš„ä¸€äº›å‡†å¤‡å·¥ä½œ   |
| `onModuleDestroy()`           | `OnModuleDestroy`           | åº”ç”¨å…³é—­æ—¶           | æ¨¡å—é”€æ¯æ—¶æ¸…ç†èµ„æº     |
| `beforeApplicationShutdown()` | `BeforeApplicationShutdown` | å…³é—­å‰æ‰§è¡Œï¼ˆå¯å¼‚æ­¥ï¼‰ | ä¼˜é›…å…³é—­æ•°æ®åº“è¿æ¥     |
| `onApplicationShutdown()`     | `OnApplicationShutdown`     | åº”ç”¨å®Œå…¨å…³é—­         | æ¸…ç†ä¸´æ—¶æ–‡ä»¶ã€æ—¥å¿—ç­‰   |

------

## ğŸ”„ å››ã€Provider ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆç±»çº§åˆ«ï¼‰

æ¯ä¸ª `@Injectable()` çš„ç±»ä¹Ÿå¯ä»¥å®ç°ç±»ä¼¼é’©å­ï¼š

| ç”Ÿå‘½å‘¨æœŸé’©å­              | è§¦å‘æ—¶æœº             |
| ------------------------- | -------------------- |
| `onModuleInit()`          | å½“æ‰€åœ¨æ¨¡å—è¢«åˆå§‹åŒ–æ—¶ |
| `onApplicationShutdown()` | åº”ç”¨å…³é—­æ—¶è°ƒç”¨       |

ä¾‹å¦‚ä¸€ä¸ªæ•°æ®åº“æœåŠ¡ `PrismaService` å°±å¸¸å¸¸å®ç°è¿™ä¸¤ä¸ªï¼š

```typescript
export class PrismaService implements OnModuleInit, OnApplicationShutdown {
  async onModuleInit() {
    await this.$connect();
  }
  async onApplicationShutdown() {
    await this.$disconnect();
  }
}
```

------

## ğŸ§  äº”ã€æ‹¦æˆªå™¨ / å®ˆå« / è¿‡æ»¤å™¨ ç”Ÿå‘½å‘¨æœŸé¡ºåº

```latex
1ï¸âƒ£ å…¨å±€å®ˆå«ï¼ˆAPP_GUARDï¼‰
2ï¸âƒ£ æ§åˆ¶å™¨å®ˆå«
3ï¸âƒ£ è·¯ç”±å®ˆå«
4ï¸âƒ£ å…¨å±€æ‹¦æˆªå™¨ï¼ˆAPP_INTERCEPTORï¼‰
5ï¸âƒ£ æ§åˆ¶å™¨æ‹¦æˆªå™¨
6ï¸âƒ£ è·¯ç”±æ‹¦æˆªå™¨
7ï¸âƒ£ æ‰§è¡Œæ§åˆ¶å™¨æ–¹æ³•
8ï¸âƒ£ æ•è·å¼‚å¸¸ â†’ å…¨å±€è¿‡æ»¤å™¨ï¼ˆAPP_FILTERï¼‰
```

------

## ğŸ“Š å…­ã€æ•´ä½“æ‰§è¡Œæ—¶åºå›¾ï¼ˆæ±‡æ€»ç‰ˆï¼‰

```latex
bootstrap()
 â”œâ”€ AppModule åˆå§‹åŒ–
 â”‚    â”œâ”€ imports -> åŠ è½½ä¾èµ–æ¨¡å—
 â”‚    â”œâ”€ providers -> æ³¨å†ŒæœåŠ¡
 â”‚    â”œâ”€ controllers -> æ³¨å†Œæ§åˆ¶å™¨
 â”‚    â””â”€ onModuleInit()
 â”‚
 â”œâ”€ å…¨éƒ¨æ¨¡å—åŠ è½½å®Œ
 â”‚    â””â”€ onApplicationBootstrap()
 â”‚
 â”œâ”€> app.listen()
 â”‚
 â–¼
=== è¯·æ±‚è¿›å…¥ ===
 â”œâ”€ Middleware
 â”œâ”€ Guard
 â”œâ”€ Interceptor (before)
 â”œâ”€ Controller
 â”œâ”€ Service
 â”œâ”€ Interceptor (after)
 â”œâ”€ ExceptionFilter (if error)
 â””â”€ è¿”å›å“åº”
```

------

## ğŸ§© ä¸ƒã€åº”ç”¨å…³é—­é˜¶æ®µ

```latex
app.close()
 â”œâ”€ beforeApplicationShutdown()
 â”œâ”€ onModuleDestroy()
 â”œâ”€ onApplicationShutdown()
 â””â”€ è¿›ç¨‹é€€å‡º
```

